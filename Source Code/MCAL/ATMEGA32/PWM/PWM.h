/*
 * PWM.h
 *
 * Created: 2/23/2022 11:50:53 PM
 * Author: Mohamed Nasser
 */ 


#ifndef PWM_H_
#define PWM_H_

/* file includes */
#include "STD_TYPES.h"
#include "BIT_MATH.h"
#include "DIO.h"

/* the frequency of MCU */
#define F_CPU 2000000UL

/* PWM OC0 Modes */
#define OC0_PHASE_CORRECT_PWM 				1
#define OC0_FAST_PWM 						3

/* PWM OC1A & OC1B Modes */
#define OC1_PHASE_CORRECT_8_BITS  			1
#define OC1_PHASE_CORRECT_9_BITS  			2
#define OC1_PHASE_CORRECT_10_BITS  			3
#define OC1_FAST_PWM_8_BITS  				5
#define OC1_FAST_PWM_9_BITS  				6
#define OC1_FAST_PWM_10_BITS  				7
#define OC1_PHASE_FREQUENCY_CORRECT_ICR1  	8
#define OC1_PHASE_FREQUENCY_CORRECT_OCR1A   9 
#define OC1_PHASE_CORRECT_ICR1  			10
#define OC1_PHASE_CORRECT_OCR1A  			11
#define OC1_FAST_PWM_ICR1  					14
#define OC1_FAST_PWM_OCR1A  				15

#define OC1A_PHASE_CORRECT_8_BITS           OC1_PHASE_CORRECT_8_BITS  			
#define OC1A_PHASE_CORRECT_9_BITS           OC1_PHASE_CORRECT_9_BITS  			
#define OC1A_PHASE_CORRECT_10_BITS  		OC1_PHASE_CORRECT_10_BITS
#define OC1A_FAST_PWM_8_BITS  				OC1_FAST_PWM_8_BITS
#define OC1A_FAST_PWM_9_BITS  				OC1_FAST_PWM_9_BITS
#define OC1A_FAST_PWM_10_BITS  				OC1_FAST_PWM_10_BITS
#define OC1A_PHASE_FREQUENCY_CORRECT_ICR1  	OC1_PHASE_FREQUENCY_CORRECT_ICR1
/*#define OC1A_PHASE_FREQUENCY_CORRECT_OCR1A  OC1_PHASE_FREQUENCY_CORRECT_OCR1A*//* fixed duty cycle 50 % */
#define OC1A_PHASE_CORRECT_ICR1  			OC1_PHASE_CORRECT_ICR1
/*#define OC1A_PHASE_CORRECT_OCR1A  		OC1_PHASE_CORRECT_OCR1A*/            /* fixed duty cycle 50 % */
#define OC1A_FAST_PWM_ICR1  				OC1_FAST_PWM_ICR1
/*#define OC1A_FAST_PWM_OCR1A  				OC1_FAST_PWM_OCR1A*/                 /* fixed duty cycle 50 % */

#define OC1B_PHASE_CORRECT_8_BITS           OC1_PHASE_CORRECT_8_BITS
#define OC1B_PHASE_CORRECT_9_BITS           OC1_PHASE_CORRECT_9_BITS
#define OC1B_PHASE_CORRECT_10_BITS  		OC1_PHASE_CORRECT_10_BITS
#define OC1B_FAST_PWM_8_BITS  				OC1_FAST_PWM_8_BITS
#define OC1B_FAST_PWM_9_BITS  				OC1_FAST_PWM_9_BITS
#define OC1B_FAST_PWM_10_BITS  				OC1_FAST_PWM_10_BITS
#define OC1B_PHASE_FREQUENCY_CORRECT_ICR1  	OC1_PHASE_FREQUENCY_CORRECT_ICR1
#define OC1B_PHASE_FREQUENCY_CORRECT_OCR1A  OC1_PHASE_FREQUENCY_CORRECT_OCR1A
#define OC1B_PHASE_CORRECT_ICR1  			OC1_PHASE_CORRECT_ICR1
#define OC1B_PHASE_CORRECT_OCR1A  			OC1_PHASE_CORRECT_OCR1A
#define OC1B_FAST_PWM_ICR1  				OC1_FAST_PWM_ICR1
#define OC1B_FAST_PWM_OCR1A  				OC1_FAST_PWM_OCR1A

/* PWM OC2 Modes */
#define OC2_PHASE_CORRECT_PWM 				1
#define OC2_FAST_PWM						3

/* PWM channel waveform modes */
#define DISCONNECT							0
#define NON_INVERTING						2
#define INVERTING							3

/* PWM OC0 pre-scaler */
#define	OC0_NO_CLK							0
#define	OC0_PRESCALER_1                     1
#define	OC0_PRESCALER_8						2
#define	OC0_PRESCALER_64                    3
#define	OC0_PRESCALER_256                   4
#define	OC0_PRESCALER_1024                  5

/* PWM OC1A & OC1B pre-scaler */
#define	OC1_NO_CLK							0
#define	OC1_PRESCALER_1                     1
#define	OC1_PRESCALER_8						2
#define	OC1_PRESCALER_64                    3
#define	OC1_PRESCALER_256                   4
#define	OC1_PRESCALER_1024                  5

#define	OC1A_NO_CLK							OC1_NO_CLK
#define	OC1A_PRESCALER_1                    OC1_PRESCALER_1
#define	OC1A_PRESCALER_8					OC1_PRESCALER_8
#define	OC1A_PRESCALER_64                   OC1_PRESCALER_64
#define	OC1A_PRESCALER_256                  OC1_PRESCALER_256
#define	OC1A_PRESCALER_1024                 OC1_PRESCALER_1024

#define	OC1B_NO_CLK							OC1_NO_CLK
#define	OC1B_PRESCALER_1                    OC1_PRESCALER_1
#define	OC1B_PRESCALER_8					OC1_PRESCALER_8
#define	OC1B_PRESCALER_64                   OC1_PRESCALER_64
#define	OC1B_PRESCALER_256                  OC1_PRESCALER_256
#define	OC1B_PRESCALER_1024                 OC1_PRESCALER_1024

/* PWM OC2 pre-scaler */
#define OC2_NO_CLK                          0
#define OC2_PRESCALER_1                     1
#define OC2_PRESCALER_8                     2
#define OC2_PRESCALER_32                    3
#define OC2_PRESCALER_64                    4
#define OC2_PRESCALER_128                   5
#define OC2_PRESCALER_256                   6
#define OC2_PRESCALER_1024                  7

/* PWM channel */
#define OC0_CHANNEL                         0
#define OC1A_CHANNEL                        1
#define OC1B_CHANNEL                        2
#define OC2_CHANNEL				            3

/* APIs for PWM */
/*
**************************************************************************************************************************************
**************************************************************************************************************************************
for OC0:
--------
for fast PWM,  the frequency equation is
         F_CPU
freq = ----------
        N * 256
------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1        |     8       |    64        |    256        |    1024        |
------------------------------------------------------------------------------------------
1			  |  3.90625 k |  488.28125  |  61.03515625 |  15.25878906  |   3.814697266  |
2             |  7.8125  k |  976.5625   |  122.0703125 |  30.51757813  |   7.629394531  |
4             |  15.625  k |  1.953125 k |  244.140625  |  61.03515625  |   15.25878906  |
8			  |  31.25   k |  3.90625  k |  488.28125   |  122.0703125	|   30.51757813  |
------------------------------------------------------------------------------------------
for phase correct PWM,  the frequency equation is
        F_CPU
freq = ------------- 
        N * 2 * 255
-------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1            |     8          |    64        |    256        |    1024        |
-------------------------------------------------------------------------------------------------
1			  |  1.960784314 k |  245.0980392   |  30.6372549  |  7.659313725  |   1.914828431  |
2             |  3.921568627 k |  490.1960784   |  61.2745098  |  15.31862745  |   3.829656863  |
4             |  7.843137255 k |  980.3921569   |  122.5490196 |  30.6372549   |   7.659313725  |
8			  |  15.68627451 k |  1.960784314 k |  245.0980392 |  61.2745098   |   15.31862745  |
-------------------------------------------------------------------------------------------------

**************************************************************************************************************************************
**************************************************************************************************************************************

for OC2:
--------
for fast PWM,  the frequency equation is
         F_CPU
freq = ----------
         N * 256
-------------------------------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1        |     8       |   32         |   64         |    128        |  256          |    1024        |
-------------------------------------------------------------------------------------------------------------------------
1			  |  3.90625 k |  488.28125  |  122.0703125 |  61.03515625 |  30.51757813  |  15.25878906  |   3.814697266  |
2             |  7.8125  k |  976.5625   |  244.140625  |  122.0703125 |  61.03515625  |  30.51757813  |   7.629394531  |
4             |  15.625  k |  1.953125 k |  488.28125   |  244.140625  |  122.0703125  |  61.03515625  |   15.25878906  |
8			  |  31.25   k |  3.90625  k |  976.5625    |  488.28125   |  244.140625   |  122.0703125  |   30.51757813  |
-------------------------------------------------------------------------------------------------------------------------
for phase correct PWM,  the frequency equation is
         F_CPU
freq = -------------
        N * 2 * 255
--------------------------------------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1            |     8          |   32          |   64         |    128        |  256         |    1024        |
--------------------------------------------------------------------------------------------------------------------------------
1			  |  1.960784314 k |  245.0980392   |  61.2745098   |  30.6372549  |  15.31862745  | 7.659313725  |   1.914828431  |
2             |  3.921568627 k |  490.1960784   |  122.5490196  |  61.2745098  |  30.6372549   | 15.31862745  |   3.829656863  |
4             |  7.843137255 k |  980.3921569   |  245.0980392  |  122.5490196 |  61.2745098   | 30.6372549   |   7.659313725  |
8			  |  15.68627451 k |  1.960784314 k |  490.1960784  |  245.0980392 |  122.5490196  | 61.2745098   |   15.31862745  |
--------------------------------------------------------------------------------------------------------------------------------

**************************************************************************************************************************************
**************************************************************************************************************************************
	
for OC1:
--------
for fast PWM 8-bit,  the frequency equation is
         F_CPU
freq = ----------
        N * 256
------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1        |     8       |    64        |    256        |    1024        |
------------------------------------------------------------------------------------------
1			  |  3.90625 k |  488.28125  |  61.03515625 |  15.25878906  |   3.814697266  |
2             |  7.8125  k |  976.5625   |  122.0703125 |  30.51757813  |   7.629394531  |
4             |  15.625  k |  1.953125 k |  244.140625  |  61.03515625  |   15.25878906  |
8			  |  31.25   k |  3.90625  k |  488.28125   |  122.0703125	|   30.51757813  |
------------------------------------------------------------------------------------------
for fast PWM 9-bit,  the frequency equation is
         F_CPU
freq = ----------
        N * 512
-------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1         |     8       |    64        |    256        |    1024        |
-------------------------------------------------------------------------------------------
1			  |  1.953125 k |  244.140625 |  30.51757813 |  7.629394531  |   1.907348633  |
2             |  3.90625  k |  488.28125  |  61.03515625 |  15.25878906  |   3.814697266  |
4             |  7.8125   k |  976.5625   |  122.0703125 |  30.51757813  |   7.629394531  |
8			  |  15.625   k |  1.953125 k |  244.140625  |  61.03515625	 |   15.25878906  |
-------------------------------------------------------------------------------------------
for fast PWM 10-bit,  the frequency equation is
         F_CPU
freq = ----------
        N * 1024
--------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1         |     8       |    64         |    256        |    1024        |
--------------------------------------------------------------------------------------------
1			  |  976.5625   |  122.0703125 |  15.25878906 |  3.814697266  |   0.953674316  |
2             |  1.953125 k |  244.140625  |  30.51757813 |  7.629394531  |   1.907348633  |
4             |  3.90625  k |  488.28125   |  61.03515625 |  15.25878906  |   3.814697266  |
8			  |  7.8125   k |  976.5625    |  122.0703125 |  30.51757813  |   7.629394531  |
--------------------------------------------------------------------------------------------
for fast PWM mode 14,  the frequency equation is
         F_CPU
freq = --------------
        N * (ICP1+1)
--------------------------------------------------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1               |     8               |    64                   |    256                   |    1024                     |
--------------------------------------------------------------------------------------------------------------------------------------------
1			  |  [1M-15.25878906] |  [125k-1.907348633] |  [15.625k-0.2384185791] |  [3.90625k-0.05960464478]|   [976.5625-0.01490116119]  |
2             |  [2M-30.51757813] |  [250k-3.814697266] |  [31.25k-0.4768371582]  |  [7.8125k-0.1192092896]  |   [1.953125k-0.02980232239] |
4             |  [4-61.03515625]  |  [500k-7.629394531] |  [62.5k-0.953674316]    |  [15.625k-0.2384185791]  |   [3.90625k-0.05960464478]  |
8			  |  [8M-122.0703125] |  [1M-15.25878906]   |  [125k-1.907348633]     |  [31.25k-0.4768371582]   |   [7.8125k-0.1192092896]    |
--------------------------------------------------------------------------------------------------------------------------------------------
for fast PWM mode 15,  the frequency equation is
         F_CPU                                                            F_CPU
freq = ------------------- for OC1A  with 50 % duty cycle and    freq = --------------- for OC1B with duty cycle depend on OCR1B 
        N * 2 * (OCR1A+1)                                                N * (OCR1A+1)
for OC1A fixed duty cycle with same last table but 0.5 scaled.
for OC1B with same last table. 
-----------------------------------------------------------------		
for phase correct PWM 8-bit,  the frequency equation is
        F_CPU
freq = -------------
        N * 2 * 255
-------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1            |     8          |    64        |    256        |    1024        |
-------------------------------------------------------------------------------------------------
1			  |  1.960784314 k |  245.0980392   |  30.6372549  |  7.659313725  |   1.914828431  |
2             |  3.921568627 k |  490.1960784   |  61.2745098  |  15.31862745  |   3.829656863  |
4             |  7.843137255 k |  980.3921569   |  122.5490196 |  30.6372549   |   7.659313725  |
8			  |  15.68627451 k |  1.960784314 k |  245.0980392 |  61.2745098   |   15.31862745  |
-------------------------------------------------------------------------------------------------
for phase correct PWM 9-bit,  the frequency equation is
        F_CPU
freq = -------------
        N * 2 * 511
-------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1            |     8          |    64        |    256        |    1024        |
-------------------------------------------------------------------------------------------------
1			  |  978.4735812   |  122.3091977   |  15.28864971 |  3.822162427  |   0.9555406067 |
2             |  1.956947162 k |  244.6183953   |  30.57729941 |  7.644324853  |   1.911081213  |
4             |  3.913894325 k |  489.2367906   |  61.15459883 |  15.28864971  |   3.822162427  |
8			  |  7.82778865  k |  978.4735812   |  122.3091977 |  30.57729941  |   7.644324853  |
-------------------------------------------------------------------------------------------------
for phase correct PWM 10-bit,  the frequency equation is
        F_CPU
freq = -------------
        N * 2 * 1023
-------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1            |     8          |    64        |    256        |    1024        |
-------------------------------------------------------------------------------------------------
1			  |  488.7585533   |  61.09481916   |  7.636852395 |  1.909213099  |   0.4773032747 |
2             |  977.5171065   |  122.1896383   |  15.27370479 |  3.818426197  |   0.9546065494 |
4             |  1.955034213 k |  244.3792766   |  30.54740958 |  7.636852395  |   1.909213099  |
8			  |  3.910068426 k |  488.7585533   |  61.09481916 |  15.27370479  |   3.818426197  |
-------------------------------------------------------------------------------------------------
for phase correct PWM mode 10 and phase and frequency correct PWM mode 8,  the frequency equation is
        F_CPU
freq = -----------------
        N * 2 * ICP1
--------------------------------------------------------------------------------------------------------------------------------------------------
F_CPU(MHZ)/N  |   1                  |     8                 |    64                  |    256                     |    1024                     |
--------------------------------------------------------------------------------------------------------------------------------------------------
1			  |  [500k-7.6299510948] |  [62.5k-0.9536888685] |  [7.8125k-0.119211108] |  [1.953125k-0.02980277714] |   [488.28125-0.007450694]   |
2             |  [1M-15.2590219]     |  [125k-1.907377737]   |  [15.625k-0.238422217] |  [3.90625k-0.059605554]    |   [976.5625-0.01490138857 ] |
4             |  [2M-30.51804379]    |  [250k-3.814755474]   |  [31.25k-0.476844434]  |  [7.8125k-0.119211108]     |   [1.953125k-0.02980277714] |
8			  |  [4M-61.03608759]    |  [500k-7.6299510948]  |  [62.5k-0.9536888685]  |  [15.625k-0.238422217]     |   [3.90625k-0.059605554]    |
--------------------------------------------------------------------------------------------------------------------------------------------------
for phase correct PWM mode 11 and phase and frequency correct PWM mode 9,  the frequency equation is
        F_CPU
freq = ---------------- 
        N * 2 * OCR1A
         F_CPU                                                            F_CPU
freq = ------------------- for OC1A  with 50 % duty cycle and    freq = ------------------- for OC1B with duty cycle depend on OCR1B
         N * 4 * OCR1A                                                   N * 2 * OCR1A
for OC1A fixed duty cycle with same last table but 0.5 scaled.
for OC1B with same last table.
*/


void PWM_InitWithConstFreq(uint8_t channel,uint8_t PWM_mode,uint8_t connection_mode,uint8_t prescaler,float32_t duty_cycle);
void PWM_InitWithVarFreq(uint8_t channel,uint8_t PWM_mode,uint8_t connection_mode,uint8_t prescaler,float32_t frequency,float32_t duty_cycle);
void PWM_Start(uint8_t channel);
void PWM_Stop(uint8_t channel);
void PWM_ChangePWMProperties(uint8_t channel,uint8_t connection_mode,float32_t duty_cycle);
#endif /* PWM_H_ */